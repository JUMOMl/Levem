# Интеграция с внешними сервисами

## 1. Выбранный сервис и обоснование

**Выбранный сервис:** Telegram Bot API

**Обоснование выбора:**
- Telegram обеспечивает мгновенные уведомления пользователям
- Популярный мессенджер с широкой аудиторией
- Простота интеграции и настройки
- Возможность форматирования сообщений и использования эмодзи
- Надежность и стабильность сервиса

## 2. Настройка интеграции

### 2.1 Создание Telegram бота

1. **Получение токена бота:**
   - Обращение к [@BotFather](https://t.me/BotFather) в Telegram
   - Создание нового бота командой `/newbot`
   - Получение уникального токена бота в формате `123456789:ABCdefGhIjKlMnOpQrStUvWxYz`

2. **Получение chat_id:**
   - Добавление бота в чат/канал или личное общение с ботом
   - Использование метода `getUpdates` для получения chat_id
   - Получение положительного числа для личных чатов или отрицательного для групп

### 2.2 Конфигурация переменных окружения

Создан файл `.env.example` с необходимыми переменными:

```env
TELEGRAM_BOT_TOKEN=your_bot_token_here
TELEGRAM_CHAT_ID=your_chat_id_here
DATABASE_URL=sqlite:///main_database.db
```

## 3. Реализация интеграции

### 3.1 Создание модуля уведомлений

Создан файл `utils/telegram.py` с основными функциями:

- `send_telegram_message(message)` - отправка сообщения в Telegram
- `format_event_created_message()` - форматирование уведомления о создании мероприятия
- `format_ticket_purchased_message()` - форматирование уведомления о покупке билета

**Ключевые особенности реализации:**
- Обработка ошибок при отсутствии переменных окружения
- Проверка успешности отправки через API
- Логирование всех операций
- Обработка сетевых ошибок

### 3.2 Интеграция в основное приложение

**Модифицированные файлы:**

1. **organizerInterface.py:**
   - Добавлен импорт модуля Telegram
   - Отправка уведомления при создании мероприятия
   - Сохранение основной функциональности при ошибках отправки

2. **ticketPurchaseInterface.py:**
   - Добавлен импорт модуля Telegram
   - Отправка уведомления при покупке билета
   - Обработка ошибок интеграции

3. **requirements.txt:**
   - Добавлены зависимости: `requests==2.31.0`, `python-dotenv==1.0.0`

### 3.3 Диаграмма архитектуры интеграции

Создана диаграмма, иллюстрирующая поток данных и интеграцию:

```
Пользователь → Организатор/Покупатель → Основное приложение Levem
    ↓
OrganizerInterface/TicketPurchaseInterface → Создание мероприятия/Покупка билета
    ↓
Сохранение в базу данных → Форматирование сообщения
    ↓
utils.telegram.send_telegram_message → Telegram Bot API → Telegram чат
```

## 4. Тестирование интеграции

### 4.1 Автоматическое тестирование

Создан тестовый скрипт `test_telegram_integration.py` для проверки функциональности:

**Сценарии тестирования:**
1. Создание тестового организатора
2. Создание мероприятия с отправкой уведомления
3. Создание тестового покупателя
4. Покупка билета с отправкой уведомления
5. Очистка тестовых данных

### 4.2 Тестирование вручную

**Пошаговые инструкции:**

1. **Настройка окружения:**
   ```bash
   cp .env.example .env
   # Отредактировать .env, добавив реальные токены
   ```

2. **Установка зависимостей:**
   ```bash
   pip install -r requirements.txt
   ```

3. **Запуск тестирования:**
   ```bash
   python test_telegram_integration.py
   ```

4. **Проверка уведомлений:**
   - Уведомления должны появляться в Telegram чате
   - Логирование показывает статус отправки
   - Основная функциональность работает даже при сбое интеграции

### 4.3 Обработка ошибок

**Реализованная обработка ошибок:**
- Отсутствие переменных окружения (логируется ошибка)
- Проблемы сети (обработка исключений requests)
- Ошибки Telegram API (проверка статуса ответа)
- Форматирование ошибок в логах

**Принцип работы при ошибках:**
- Ошибки логируются, но не прерывают основной процесс
- Пользователь получает уведомление об ошибке интеграции
- Система продолжает работать нормально

## 5. Безопасность

### 5.1 Рекомендации по безопасности

1. **Конфиденциальность токенов:**
   - Никогда не публиковать токен бота в публичных репозиториях
   - Использовать переменные окружения для хранения чувствительных данных
   - Добавлять `.env` в `.gitignore`

2. **Ограничение доступа бота:**
   - Настраивать ограничения в BotFather для безопасности
   - Регулярно обновлять токены
   - Мониторить активность бота

3. **Обработка данных:**
   - Проверять входные данные перед отправкой
   - Избегать передачи конфиденциальной информации
   - Логировать все операции для аудита
